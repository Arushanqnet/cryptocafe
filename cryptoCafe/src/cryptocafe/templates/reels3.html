<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto News - Reels</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Bootstrap CSS for base styling -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  >
  <!-- Fabric.js library -->
  <script
    src="https://cdn.jsdelivr.net/npm/fabric@5.2.4/dist/fabric.min.js">
  </script>
  <!-- Font Awesome for icons -->
 

  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #000;
      color: #fff;
    }
    #reels-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      
    }

    .canvas-container{
        justify-self: center !important;
    }
    #reels-canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    /* Overlay UI elements */
    .overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 20px;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      box-sizing: border-box;
    }
    .profile-section {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #ccc;
      margin-right: 10px;
    }
    .profile-name {
      font-weight: bold;
    }
    .icons-section {
      position: absolute;
      right: 20px;
      bottom: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .icon-btn {
      color: #fff;
      font-size: 28px;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      cursor: pointer;
    }
    .music-bar {
      position: absolute;
      bottom: 80px;
      left: 20px;
      display: flex;
      align-items: center;
      font-size: 14px;
    }
    .music-bar i {
      margin-right: 10px;
    }
    /* Swipe indicator */
    .swipe-up {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      text-align: center;
    }
    .swipe-up i {
      display: block;
      margin-bottom: 5px;
      animation: swipe 2s infinite;
    }
    @keyframes swipe {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }
  </style>
</head>
<body>
    
  <div id="reels-container">
    <canvas id="reels-canvas" width="360" height="640"></canvas>
    <!-- Overlay UI elements -->
    <div class="overlay">
      <div class="profile-section">
        <div class="profile-pic"></div>
        <div class="profile-name">CryptoDailyNews</div>
      </div>
      <div id="text-content">
        <div id="news-title" style="font-size: 20px; font-weight: bold;"></div>
        <div id="news-description" style="font-size: 16px; margin-top: 5px;"></div>
      </div>
    </div>
    <div class="icons-section">
      <div class="icon-btn"><i class="fas fa-heart"></i></div>
      <div class="icon-btn"><i class="fas fa-comment"></i></div>
      <div class="icon-btn"><i class="fas fa-share"></i></div>
      <div class="icon-btn" id="play-pause-btn"><i class="fas fa-pause"></i></div>
    </div>
    <div class="music-bar">
      <i class="fas fa-music"></i>
      <div>Trending News Sound</div>
    </div>
    <div class="swipe-up">
      <i class="fas fa-chevron-up"></i>
      Swipe up for more
    </div>
  </div>

  <script>
    // Grab the news data passed from the server
    // Assuming 'newsItems' is defined, replace with your actual data fetching
    const newsItems = JSON.parse('{{ data|tojson }}');

    // Initialize Fabric.js canvas
    const canvas = new fabric.Canvas('reels-canvas', {
      renderOnAddRemove: false
    });

    let currentIndex = 0;
    let isPaused = false;
    let synth = window.speechSynthesis;
    let utterance = null;

    // DOM elements
    const playPauseBtn = document.getElementById('play-pause-btn');

    // Helper function to speak text
    function speakText(text) {
      // Stop any ongoing speech
      if (utterance && synth.speaking) {
        synth.cancel();
      }

      utterance = new SpeechSynthesisUtterance(text);
      isPaused = false;
      playPauseBtn.textContent = 'Pause';

      // Event listeners for speech synthesis
      utterance.onend = () => {
        isPaused = false;
        playPauseBtn.textContent = 'Play';
        // Stop animations when speech ends
        stopTextAnimations();
      };

      utterance.onpause = () => {
        isPaused = true;
        playPauseBtn.textContent = 'Play';
      };

      utterance.onresume = () => {
        isPaused = false;
        playPauseBtn.textContent = 'Pause';
      };

      synth.speak(utterance);

      // Start text animations
      startTextAnimations();
    }

    // Load and render a single news item on the Fabric.js canvas
    async function showNewsItem(index) {
      // Bounds check
      if (index < 0 || index >= newsItems.length) {
        return;
      }
      currentIndex = index;

      // Clear the canvas
      canvas.clear();

      const item = newsItems[index];
      const imageUrl = item.image_url;

      // Set the background image
      setBackground(imageUrl).then(() => {
        // Add title and description after background is set
        addTextObjects(item);
        canvas.renderAll();
        // Read the news text out loud
        speakText(item.text || '');
      });
    }

    // Set background image function
    function setBackground(imageUrl) {
      return new Promise((resolve, reject) => {
        fabric.Image.fromURL(imageUrl, function(img) {
          if (!img) {
            // Fallback image
            fabric.Image.fromURL('https://via.placeholder.com/360x600.png?text=No+Image', function(placeholder) {
              canvas.setBackgroundImage(placeholder, canvas.renderAll.bind(canvas), {
                scaleX: canvas.width / placeholder.width,
                scaleY: canvas.height / placeholder.height
              });
              resolve();
            });
          } else {
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
              scaleX: canvas.width / img.width,
              scaleY: canvas.height / img.height
            });
            resolve();
          }
        }, { crossOrigin: 'anonymous' });
      });
    }

    // Add title and description text objects with animations
function addTextObjects(item) {
  // Title Text
  const titleObj = new fabric.Textbox(item.title || 'No Title', {
    left: 20,
    top: 50,
    width: canvas.width - 40,
    fontSize: 20,
    fontWeight: 'bold',
    fill: '#ffffff',
    shadow: 'rgba(0,0,0,0.3) 2px 2px 5px',
    opacity: 0, // Start fully transparent
  });
  canvas.add(titleObj);

  // Description Text
  const textObj = new fabric.Textbox(item.text || 'No Description', {
    left: 20,
    top: 150,
    width: canvas.width - 40,
    fontSize: 18,
    fill: '#ffffff',
    shadow: 'rgba(0,0,0,0.3) 2px 2px 5px',
    opacity: 0, // Start fully transparent
  });
  canvas.add(textObj);

  // Animate the title text fade-in
  titleObj.animate('opacity', 1, {
    onChange: canvas.renderAll.bind(canvas),
    duration: 1000,
    easing: fabric.util.ease.easeInOutQuad,
  });

  // Animate the description text fade-in with a slight delay
  textObj.animate('opacity', 1, {
    onChange: canvas.renderAll.bind(canvas),
    duration: 1000,
    delay: 500,
    easing: fabric.util.ease.easeInOutQuad,
  });

  // Store references for animations
  canvas.titleObj = titleObj;
  canvas.textObj = textObj;
}

// Function to start text animations while speech is playing
function startTextAnimations() {
  // Apply fade left/right animation to text objects
  if (canvas.titleObj && canvas.textObj) {
    animateFadeLeftRight(canvas.titleObj);
    animateFadeLeftRight(canvas.textObj);
  }
}

// Recursive function to animate fade left/right
function animateFadeLeftRight(obj) {
  const originalLeft = obj.left;
  const shift = 10; // Amount to move left and right
  const originalOpacity = obj.opacity || 1;
  const fadeToOpacity = 0.7; // Opacity to fade to

  // Animate to the left and fade out slightly
  obj.animate(
    { left: originalLeft - shift, opacity: fadeToOpacity },
    {
      duration: 1000,
      onChange: canvas.renderAll.bind(canvas),
      easing: fabric.util.ease.easeInOutQuad,
      onComplete: () => {
        // Animate to the right and fade back in
        obj.animate(
          { left: originalLeft + shift, opacity: originalOpacity },
          {
            duration: 1000,
            onChange: canvas.renderAll.bind(canvas),
            easing: fabric.util.ease.easeInOutQuad,
            onComplete: () => {
              // Animate back to original position and opacity
              obj.animate(
                { left: originalLeft, opacity: originalOpacity },
                {
                  duration: 1000,
                  onChange: canvas.renderAll.bind(canvas),
                  easing: fabric.util.ease.easeInOutQuad,
                  onComplete: () => {
                    if (!isPaused && synth.speaking) {
                      // Continue the animation recursively
                      animateFadeLeftRight(obj);
                    } else {
                      // Reset object to original state if animation stops
                      obj.set({ left: originalLeft, opacity: originalOpacity });
                      canvas.renderAll();
                    }
                  },
                }
              );
            },
          }
        );
      },
    }
  );
}
    // Function to stop text animations
    function stopTextAnimations() {
      // Stop animations by setting 'isPaused' to true
      isPaused = true;
    }

    // Initial load
    showNewsItem(currentIndex);

  

    playPauseBtn.addEventListener('click', () => {
      if (synth.speaking) {
        if (isPaused) {
          // Resume the speech
          synth.resume();
          isPaused = false;
          playPauseBtn.textContent = 'Pause';
          // Resume animations
          startTextAnimations();
        } else {
          // Pause the speech
          synth.pause();
          isPaused = true;
          playPauseBtn.textContent = 'Play';
          // Stop animations
          stopTextAnimations();
        }
      } else {
        // If not speaking, start the speech
        const item = newsItems[currentIndex];
        speakText(item.text || '');
      }
    });

    
    // Swipe interactions
    let startY = null;
    window.addEventListener('touchstart', function(e) {
      startY = e.touches[0].clientY;
    });
    window.addEventListener('touchmove', function(e) {
      if (!startY) return;
      let deltaY = startY - e.touches[0].clientY;
      if (deltaY > 50) {
        // Swiped up
        nextItem();
        startY = null;
      } else if (deltaY < -50) {
        // Swiped down
        prevItem();
        startY = null;
      }
    });

    // Keyboard interactions for desktop testing
    window.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowUp') {
        nextItem();
      } else if (e.key === 'ArrowDown') {
        prevItem();
      }
    });

    function nextItem() {
      synth.cancel(); // Stop current speech
      currentIndex = (currentIndex + 1) % newsItems.length;
      showNewsItem(currentIndex);
    }

    function prevItem() {
      synth.cancel(); // Stop current speech
      currentIndex = (currentIndex - 1 + newsItems.length) % newsItems.length;
      showNewsItem(currentIndex);
    }
  </script>
</body>
</html>